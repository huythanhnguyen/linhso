/**
 * Fixes CSS - Phone Analysis App
 * CSS để sửa các lỗi cụ thể và tăng tính nhất quán cho app
 */

/* ===== CHAT DISPLAY FIXES ===== */

/* Điều chỉnh bố cục chat cho tất cả thiết bị */
.chat-panel {
    /* Đảm bảo panel chiếm toàn bộ không gian khả dụng */
    display: flex;
    flex-direction: column;
    height: calc(100vh - 200px);
    min-height: 500px;
    max-height: 80vh;
    position: relative;
    overflow: hidden;
}

/* Vấn đề chính: chat input cố định ở dưới cùng */
.chat-input {
    position: absolute; 
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 50;
    background-color: #f9f9f9;
    border-top: 1px solid var(--border-color);
    padding: var(--space-md) var(--space-lg);
    padding-bottom: calc(var(--space-md) + env(safe-area-inset-bottom, 0px));
    display: flex;
    align-items: center;
}

/* Đảm bảo khu vực tin nhắn có padding để không bị che bởi input */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-lg);
    padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
    -webkit-overflow-scrolling: touch;
    position: relative;
    height: 100%;
}

/* Đảm bảo kích thước và định dạng bubble chat đúng */
.message {
    width: auto !important;
    max-width: 70%;
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-lg);
    position: relative;
    animation: fadeIn 0.3s ease-in-out;
    line-height: 1.5;
    border: 1px solid var(--border-color);
    
    /* Đảm bảo ngắt từ đúng cách */
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    -webkit-hyphens: auto;
    hyphens: auto;
    
    /* Tự động mở rộng chiều cao */
    min-height: auto;
    height: auto !important;
    max-height: none !important;
    
    /* Hiển thị đúng */
    display: inline-block;
}

/* Nội dung tin nhắn */
.message-content {
    /* Quan trọng cho việc ngắt dòng */
    white-space: normal !important;
    overflow: visible;
    width: 100%;
    display: inline !important;
    
    /* Tránh giới hạn kích thước */
    min-height: auto;
    height: auto !important;
    max-height: none !important;
}

/* Typing Indicator Fix */
.typing-indicator.hidden {
    display: none !important;
}

/* ===== INFO PANEL FIXES ===== */

/* Cải thiện hiển thị tabs trong info panel */
.info-tabs {
    display: flex;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    background-color: #f8f8f8;
    border-bottom: 1px solid #e0e0e0;
}

.info-tabs::-webkit-scrollbar {
    display: none;
}

.info-tab-button {
    flex: 1;
    min-width: 80px;
    white-space: nowrap;
    padding: 10px 15px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: #666;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.info-tab-button.active {
    border-bottom-color: var(--primary-color);
    color: var(--primary-color);
    font-weight: 600;
    background-color: rgba(67, 97, 238, 0.05);
}

/* ===== ANALYSIS CONTAINER FIXES ===== */

/* Đảm bảo analysis container hiển thị đúng */
.analysis-container {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin-top: 12px;
    overflow: hidden;
}

.star-item {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
}

.energy-levels {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

/* Fix cho Star Combinations */
.star-combinations-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.star-combo-item {
    background-color: #f9f9fa;
    padding: 10px;
    border-radius: var(--radius-sm);
    border-left: 2px solid #ddd;
}

.star-combo-header {
    display: flex;
    margin-bottom: 6px;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
}

/* ===== SUGGESTION CHIPS & FEEDBACK BUTTONS FIXES ===== */

/* Đảm bảo các nút gợi ý và phản hồi hiển thị đúng */
.suggestion-chips, 
.feedback-buttons {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

/* Fix hiển thị Feedback thanks */
.feedback-thanks {
    width: 100%;
    text-align: center;
    margin-top: 8px;
}

/* ===== LOADER FIXES ===== */

/* Cải thiện màn hình loading */
#loading-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: var(--background-color);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
}

/* ===== VISIBILITY & DISPLAY FIXES ===== */

/* Đảm bảo ẩn đúng */
.hidden {
    display: none !important;
}

/* Đảm bảo hiển thị đúng overlay */
.overlay.visible {
    display: block !important;
    animation: fadeIn 0.3s ease-out;
}

/* Đảm bảo hiển thị đúng info panel */
.info-panel.visible {
    transform: translateX(0) !important;
    opacity: 1 !important;
}

/* ===== SPECIFIC IOS/SAFARI FIXES ===== */

@supports (-webkit-touch-callout: none) {
    /* Sửa lỗi cụ thể cho iOS */
    
    /* Sửa lỗi hiển thị tin nhắn trên iOS */
    .message {
        width: auto !important;
        display: inline-block !important;
    }
    
    .message-content {
        display: inline !important;
    }
    
    /* Sửa kích thước văn bản Safari iOS */
    body {
        -webkit-text-size-adjust: 100%;
    }
    
    /* Sửa lỗi cuộn trang iOS */
    .chat-panel, .chat-messages {
        -webkit-transform: translateZ(0);
    }
    
    /* Sửa lỗi hiển thị trong viewport khi bàn phím hiển thị */
    @media (max-height: 600px) {
        .chat-panel {
            height: 80vh;
            max-height: -webkit-fill-available;
        }
    }
    
    /* Sửa lỗi khi có notch trên iPhone */
    @supports (padding: max(0px)) {
        .chat-input {
            padding-bottom: max(var(--space-md), calc(var(--space-md) + env(safe-area-inset-bottom)));
        }
        
        .chat-messages {
            padding-bottom: max(70px, calc(70px + env(safe-area-inset-bottom)));
        }
    }
}

/* ===== WEBKIT-SPECIFIC FIXES ===== */

/* Cải thiện thanh cuộn cho Webkit */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.03);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.15);
}

/* ===== ACCESSIBILITY FIXES ===== */

/* Cải thiện truy cập */
button, input, a {
    touch-action: manipulation; /* Tối ưu hóa touch events */
}

input, textarea, select, button {
    font-size: 16px; /* Tránh auto-zoom trên iOS */
}

/* ===== FALLBACK FIXES ===== */

/* Class hiệu ứng khi focus vào tin nhắn */
.message:focus-within {
    box-shadow: 0 0 0 2px var(--primary-color);
    outline: none;
}

/* Sửa lỗi khi JavaScript không hoạt động đúng */
.js-fallback .chat-input {
    position: static;
    bottom: auto;
}

.js-fallback .chat-messages {
    max-height: 60vh;
    overflow-y: auto;
    padding-bottom: var(--space-lg);
}

/* ===== ANIMATION PERFORMANCE FIXES ===== */

/* Tối ưu hiệu suất animation */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* Tối ưu hóa CPU/GPU */
.chat-messages, .message, .analysis-container {
    will-change: transform; /* Nâng cao hiệu suất animation */
    transform: translateZ(0); /* Kích hoạt hardware acceleration */
}

/* ===== Z-INDEX HIERARCHY ===== */

/* Đảm bảo thứ tự hiển thị đúng */
#loading-container { z-index: 9999; }
.overlay { z-index: 999; }
.info-panel { z-index: 900; }
.chat-input { z-index: 50; }
.chat-header { z-index: 40; }
.chat-messages { z-index: 30; }

/* ===== TOUCH SCREEN OPTIMIZATIONS ===== */

/* Tối ưu cho màn hình cảm ứng */
.category-btn,
.feedback-btn,
.chat-input button,
.close-button,
.chat-tools button {
    min-height: 44px; /* Kích thước tối thiểu cho các phần tử có thể chạm */
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Đảm bảo không có text selection không mong muốn */
.chat-header,
.info-panel-header,
.chat-tools button,
.category-btn,
.feedback-btn {
    -webkit-user-select: none;
    user-select: none;
}

/* ===== INPUT INTERACTION IMPROVEMENTS ===== */

/* Hiển thị theo kiểu iOS */
@media (max-width: 768px) {
    .chat-input {
        display: flex;
        align-items: center;
        background-color: #f9f9f9;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .chat-input input {
        border-radius: 20px;
        padding-left: 16px;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chat-input button {
        right: 16px;
        width: 36px;
        height: 36px;
    }
}

/* Nâng cao trải nghiệm khi focus vào input */
.chat-input input:focus {
    box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ===== CLASS RIÊNG DÀNH CHO SCRIPT FIX ===== */

/* Sửa khi chế độ landscape */
.landscape-mode .chat-panel {
    height: 60vh;
}

/* Sửa khi bàn phím hiển thị */
.keyboard-visible .chat-panel {
    height: 50vh;
}

/* Sửa khi màn hình nhỏ */
.small-screen .chat-panel {
    height: 85vh;
}
